<mat-spinner *ngIf="!campaign" class="b-full-page" color="primary" diameter="30"></mat-spinner>

<main class="b-container" *ngIf="campaign">
  <div class="b-back-button">
    <a mat-icon-button [routerLink]="'/campaign/' + campaign.id">
      <mat-icon class="campaign-icon" aria-hidden="false" aria-label="Back">keyboard_arrow_left</mat-icon>
      Back to campaign
    </a>
  </div>

  <div fxLayout="row" fxLayout.xs="column">
    <div class="b-primary-column">
      <div class="c-header">
        <h2 class="b-rh-2 b-light">You are donating to:</h2>
        <h3 class="b-rh-1 b-bold">{{ campaign.charity.name }}</h3>
        <h2 class="b-rh-2 b-light">For:</h2>
        <h1 class="b-rh-1 b-bold">{{ campaign.title }}</h1>
      </div>

      <p *ngIf="campaign && !campaignIsOpen()">Donations open {{ campaign.startDate | date : 'h:mm a, d LLLL yyyy' }} to {{ campaign.endDate | date : 'h:mm a, d LLLL yyyy' }}</p>

      <form class="c-donate-form" (ngSubmit)="submit()" [formGroup]="donationForm" *ngIf="campaign && campaignIsOpen()">
        <mat-vertical-stepper
          linear
          #stepper
          (selectionChange)="stepChanged($event)"
        >
          <mat-step
            formGroupName="amounts"
            [stepControl]="amountsGroup"
            label="Your donation"
            class="c-your-donation"
          >
            <p *ngIf="campaign.matchFundsRemaining > 0" class="c-your-donation__highlight">
              <img src="/assets/images/icon-tick.png" height="11" alt="Check mark">
              Match funds are currently available!
            </p>
            <mat-form-field class="c-your-donation__form-field b-center size-lg" color="primary">
              <span matPrefix>£</span>
              <mat-label for="donationAmount">Donation to {{ campaign.charity.name }}</mat-label>
              <input formControlName="donationAmount" id="donationAmount" matInput>
            </mat-form-field>
            <p *ngIf="suggestedAmounts && suggestedAmounts.length > 0" class="b-center b-grey b-rt-0">Or, choose</p>
            <div *ngIf="suggestedAmounts && suggestedAmounts.length > 0" class="c-suggested-amount" fxLayout="row">
              <button
                type="button"
                class="c-suggested-amount__button b-rh-2 b-bold"
                *ngFor="let suggestedAmount of suggestedAmounts"
                (click)="setAmount(suggestedAmount)"
              >{{ suggestedAmount | exactCurrency }}</button>
            </div>

            <div
              class="error"
              aria-live="polite"
              *ngIf="donationAmountField?.invalid && donationAmountField?.errors && (donationAmountField?.dirty || donationAmountField?.touched)"
            >
              <div *ngIf="donationAmountField?.errors?.min">Sorry, the minimum donation is £1.</div>
              <div *ngIf="donationAmountField?.errors?.max">Your donation must be {{ maximumDonationAmount | exactCurrency }} or less to proceed. You can make multiple matched donations of {{ maximumDonationAmount | exactCurrency }} if match funds are available.</div>
              <div *ngIf="donationAmountField?.errors?.pattern">Please enter a whole number of pounds (£) without commas.</div>
              <div *ngIf="donationAmountField?.errors?.required">Please enter how much you would like to donate.</div>
            </div>

            <p class="b-rt-1 b-bold">Support the Big Give</p>
            <p class="b-rt-0">The Big Give is the UK's #1 match funding platform, but we're a <a href="https://beta.charitycommission.gov.uk/charity-details/?regid=1136547" target="_blank"><mat-icon class="b-va-mid" aria-hidden="false" aria-label="Open in new tab">open_in_new</mat-icon>charity</a> too!</p>
            <p class="b-rt-0">
              We develop and operate the technology, and support charities as they create and run their campaigns.
              <span *ngIf="psp == 'stripe'">Donations are optional but make a vital contribution to our running costs as a charity.</span>
              <span *ngIf="psp == 'enthuse'">Donations play a vital part in paying towards our running costs as a charity. If you'd rather not support us, you can choose not to make a gift to the Big Give when finalising your donation.</span>
            </p>

            <mat-form-field
              *ngIf="psp == 'stripe'"
              class="c-your-donation__form-field b-center"
              color="primary"
            >
              <span matPrefix>£</span>
              <mat-label for="tipAmount">Donation to the Big Give</mat-label>
              <input formControlName="tipAmount" id="tipAmount" matInput>
              <mat-hint
                *ngIf="donationAmount && donationAmount > 0"
              >
                {{ ((amountsGroup.value.tipAmount || '0').replace('£', '') / donationAmount) | percent }}
              of main donation
              </mat-hint>
            </mat-form-field>

            <p class="error" *ngIf="donationCreateError" aria-live="alert">
              Sorry, we can't register your donation right now. Please try again in a moment
              or <a href="https://www.thebiggive.org.uk/s/contact-us" target="_blank">
                <mat-icon aria-hidden="false" aria-label="Open in new tab">open_in_new</mat-icon>
                  contact us</a>
              if this message persists.
            </p>

            <div>
              <button type="button" matStepperNext mat-raised-button color="primary">Next</button>
            </div>
          </mat-step>

          <mat-step
            formGroupName="giftAid"
            [stepControl]="giftAidGroup"
            label="Gift Aid"
          >
            <p class="no-margin-top b-rt-1 b-bold">Boost your donation by 25p of Gift Aid for every £1 you donate.</p>
            <p class="b-rt-0">'I confirm that I am a UK tax payer and I understand that if I pay less income tax and/or capital gains tax in the current tax year than the amount of Gift Aid claimed on all my donations it is my responsibility to pay the difference'.</p>
            <p class="b-rt-0">Gift Aid is a government scheme for UK charities to reclaim the tax you have paid and gain 25% more at no cost or hassle to you.
              <a href="https://www.thebiggive.org.uk/s/terms-and-conditions" target="_blank">
                <mat-icon class="b-va-mid" aria-hidden="false" aria-label="Open in new tab">open_in_new</mat-icon>
                  Find out more about Gift Aid</a>.
            </p>
            <mat-radio-group tabindex="0" aria-labelledby="giftAid-label" formControlName="giftAid">
              <mat-radio-button class="b-mr-2" labelPosition="after" [value]="true">Yes, I want to Gift Aid my donation to {{ campaign.charity.name }} and any additional gift I make to the Big Give, including any donations made in the past 4 years or in the future</mat-radio-button>
              <mat-radio-button class="b-mr-2" labelPosition="after" [value]="false">No, I do not meet the criteria for Gift Aid to be claimed, or do not want Gift Aid claimed</mat-radio-button>
            </mat-radio-group>

            <div *ngIf="psp == 'stripe' && giftAidGroup.value.giftAid">
              <!-- TODO split out pieces, probably use a lookup service -->
              <mat-form-field>
                <mat-label for="homeAddress">Home address</mat-label>
                <input formControlName="homeAddress" id="homeAddress" matInput>
              </mat-form-field>

              <mat-form-field>
                <mat-label for="homePostcode">Home postcode</mat-label>
                <input formControlName="homePostcode" id="homePostcode" matInput>
                <mat-hint>For your Gift Aid declaration to HMRC.</mat-hint>
              </mat-form-field>
            </div>

            <div>
              <button type="button" matStepperNext mat-raised-button color="primary">Next</button>
            </div>
          </mat-step>

          <mat-step
            formGroupName="personalAndMarketing"
            [stepControl]="personalAndMarketingGroup"
            label="Your details"
          >
            <div *ngIf="psp == 'stripe'">
              <mat-form-field>
                <mat-label for="firstName">First name</mat-label>
                <input formControlName="firstName" id="firstName" matInput>
              </mat-form-field>

              <mat-form-field>
                <mat-label for="lastName">Last name</mat-label>
                <input formControlName="lastName" id="lastName" matInput>
                <mat-hint *ngIf="giftAidGroup.value.giftAid">For Gift Aid, smooth payment and identifying you if you have questions.</mat-hint>
                <mat-hint *ngIf="!giftAidGroup.value.giftAid">For smooth payment and identifying you if you have questions.</mat-hint>
              </mat-form-field>

              <mat-form-field>
                <mat-label for="emailAddress">Email address</mat-label>
                <input formControlName="emailAddress" id="emailAddress" type="email" matInput>
                <mat-hint>We'll send you a donation receipt and use this to
                  confirm it's you in case you have any queries.</mat-hint>
              </mat-form-field>
            </div>

            <p class="b-rt-1 b-bold" id="optInCharityEmail-label">Would you be happy to receive emails from {{ campaign.charity.name }}?</p>
            <mat-radio-group tabindex="0" aria-labelledby="optInCharityEmail-label" formControlName="optInCharityEmail">
              <!-- TODO update this hint to vary based on Gift Aid selection and be clearer -->
              <mat-hint>This may include thanks for your donation, updates on how it is being used, newsletters and future campaigns. If you select no, we will pass on your details as these may be required for Gift Aid purposes, but the charity will be informed that you do not wish to receive communications.</mat-hint>
              <mat-radio-button class="b-mr-2" labelPosition="after" [value]="true">Yes, I'm happy to receive emails from {{ campaign.charity.name }}</mat-radio-button>
              <mat-radio-button class="b-mr-2" labelPosition="after" [value]="false">No, I would not like to receive emails from {{ campaign.charity.name }}</mat-radio-button>
            </mat-radio-group>
            <p *ngIf="personalAndMarketingGroup.value.optInCharityEmail === false">
              <mat-hint aria-live="polite">
                Please note that you might continue to receive communications from {{ campaign.charity.name }} if you have already shared your details with them via other methods.
              </mat-hint>
            </p>

            <p class="b-rt-1 b-bold" id="optInTbgEmail-label">Would you be happy to receive emails from the Big Give?</p>
            <mat-radio-group tabindex="0" aria-labelledby="optInTbgEmail-label" formControlName="optInTbgEmail">
              <mat-radio-button class="b-mr-2" labelPosition="after" [value]="true">Yes, I'm happy to receive emails from the Big Give</mat-radio-button>
              <mat-radio-button class="b-mr-2" labelPosition="after" [value]="false">No, I would not like to receive emails from the Big Give</mat-radio-button>
            </mat-radio-group>
            <p *ngIf="personalAndMarketingGroup.value.optInTbgEmail === false">
              <mat-hint aria-live="polite">
                By selecting 'no', we will no longer be able to email you about opportunities to double your donation.
              </mat-hint>
            </p>

            <div>
              <button type="button" matStepperNext mat-raised-button color="primary">Next</button>
            </div>
          </mat-step>

          <mat-step
            formGroupName="paymentAndAgreement"
            [stepControl]="paymentAndAgreementGroup"
            label="Confirm &amp; pay"
            class="c-make-your-donation"
          >
            <div *ngIf="psp == 'stripe'">
              <mat-form-field>
                <mat-label for="billingPostcode">Billing postcode</mat-label>
                <input formControlName="billingPostcode" id="billingPostcode" matInput>
              </mat-form-field>

              <div class="sr-combo-inputs-row">
                <mat-label for="card-info">Card</mat-label>
                <div class="sr-input sr-card-element" id="card-info" #cardInfo></div>
              </div>
            </div>

            <p class="b-rt-0 b-m-0">By clicking on the <em>Donate</em> button, you agree to the Big Give's
              <a href="https://www.thebiggive.org.uk/s/terms-and-conditions" target="_blank">
                <mat-icon class="b-va-mid" aria-hidden="false" aria-label="Open in new tab">open_in_new</mat-icon>
                  Terms and Conditions
              </a>
                and
              <a href="https://www.thebiggive.org.uk/s/privacy-policy" target="_blank">
                <mat-icon class="b-va-mid" aria-hidden="false" aria-label="Open in new tab">open_in_new</mat-icon>
                Privacy Policy</a>.
            </p>

            <div class="c-donation-summary">
              <p class="error" *ngIf="donationUpdateError" aria-live="alert">
                Sorry, we can't submit your donation right now. Please try again in a moment
                or <a href="https://www.thebiggive.org.uk/s/contact-us" target="_blank">
                  <mat-icon aria-hidden="false" aria-label="Open in new tab">open_in_new</mat-icon>
                    contact us</a>
                if this message persists.
              </p>
              <mat-spinner *ngIf="submitting" color="primary" diameter="30"></mat-spinner>

              <p *ngIf="retrying" class="error" aria-live="polite">
                It looks like our system is a bit busy, one moment please&hellip;
              </p>

              <p *ngIf="noPsps" class="error" aria-live="alert">
                Sorry, we are really busy and cannot take your donation right now. Please refresh the page in a few minutes to try again.
              </p>
  
              <p *ngIf="stripeError" class="error" aria-live="alert">
                {{ stripeError }}
              </p>

              <button
                type="submit"
                class="c-donate-button b-donate-button b-w-100 b-rt-1"
                mat-raised-button
                [disabled]="submitting || donationForm.invalid || (psp == 'stripe' &&!stripeCardReady)"
              >
                Donate
                <span class="b-bold b-va-bas">
                  {{ donationAndTipAmount | exactCurrency }}
                </span>
              </button>
              <p *ngIf="expectedTbgAmount() > 0" class="b-center b-grey b-rt-sm b-m-0">
                Including donation to support the Big Give
              </p>
              <div class="c-donation-receipt" fxLayout="row">
                <div [fxFlex]="(expectedMatchAmount() > 0) ? 26 : 39">
                  <p class="b-center b-grey b-rt-sm b-m-0">Your donation</p>
                  <p class="b-center b-grey b-rt-0 b-bold b-m-0">{{ donationAmount | exactCurrency }}</p>
                </div>
                <div fxFlex="11" fxLayout="row" fxLayoutAlign="center end">
                  <mat-icon class="c-donation-receipt__icon b-grey b-bold b-center" aria-hidden="false" aria-label="Plus">add</mat-icon>
                </div>
                <div fxFlex="26" *ngIf="expectedMatchAmount() > 0">
                  <p class="b-center b-grey b-rt-sm b-m-0">Match funds</p>
                  <p class="b-center b-grey b-rt-0 b-bold b-m-0">{{ expectedMatchAmount() | exactCurrency }}</p>
                </div>
                <div fxFlex="11" fxLayout="row" fxLayoutAlign="center end" *ngIf="expectedMatchAmount() > 0">
                  <mat-icon class="c-donation-receipt__icon b-grey b-bold b-center" aria-hidden="false" aria-label="Plus">add</mat-icon>
                </div>
                <div class="c-donation-receipt__gift-aid" [fxFlex]="(expectedMatchAmount() > 0) ? 26 : 39">
                  <p class="b-center b-grey b-rt-sm b-m-0">Gift Aid</p>
                  <p class="b-center b-grey b-rt-0 b-bold b-m-0">{{ giftAidAmount() | exactCurrency }}</p>
                </div>
              </div>
              <div class="c-receipt-total b-grey" fxLayout="row" fxLayoutAlign="space-around center">
                <p class="b-rt-0 b-m-0">Total for {{ campaign.charity.name }}:</p>
                <p class="b-rt-1 b-bold b-m-0">{{ expectedTotalAmount() | exactCurrency }}</p>
              </div>
              <div *ngIf="expectedTbgAmount() > 0" class="c-receipt-total b-grey" fxLayout="row" fxLayoutAlign="space-around center">
                <p class="b-rt-0 b-m-0">Total for the Big Give:</p>
                <p class="b-rt-1 b-bold b-m-0">{{ expectedTbgAmount() | exactCurrency }}</p>
              </div>
            </div>
          </mat-step>
        </mat-vertical-stepper>
      </form>
    </div>

    <div class="b-secondary-column">
      <app-campaign-details-card [campaign]="campaign"></app-campaign-details-card>
    </div>
  </div>
</main>

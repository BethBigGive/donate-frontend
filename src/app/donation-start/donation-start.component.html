<mat-spinner *ngIf="!campaign" class="b-full-page" color="primary" diameter="30"></mat-spinner>

<main class="b-container" *ngIf="campaign">
  <div class="b-back-button">
    <a mat-icon-button [routerLink]="'/campaign/' + campaign.id">
      <mat-icon class="campaign-icon" aria-hidden="false" aria-label="Back">keyboard_arrow_left</mat-icon>
      Back to campaign
    </a>
  </div>

  <div fxLayout="row" fxLayout.xs="column">
    <div class="b-primary-column">
      <div class="c-header">
        <h2 class="b-rh-2 b-light">You are donating to:</h2>
        <h3 class="b-rh-1 b-bold">{{ campaign.charity.name }}</h3>
        <h2 class="b-rh-2 b-light">For:</h2>
        <h1 class="b-rh-1 b-bold">{{ campaign.title }}</h1>
      </div>

      <p *ngIf="campaign && !campaignIsOpen()">Donations open {{ campaign.startDate | date : 'h:mm a, d LLLL yyyy' }} to {{ campaign.endDate | date : 'h:mm a, d LLLL yyyy' }}</p>

      <form class="c-donate-form" (ngSubmit)="submit()" [formGroup]="donationForm" *ngIf="campaign && campaignIsOpen()">
        <mat-vertical-stepper formGroupName="donationForm" linear #stepper>
          <mat-step
            *ngIf="donationForm"
            state="favorite_border"
            label="Your donation"
            class="c-your-donation"
          >
            <ng-template matStepperIcon="favorite_border">
              <mat-icon>favorite_border</mat-icon>
            </ng-template>

            <p *ngIf="campaign.matchFundsRemaining > 0" class="c-your-donation__highlight">
              <img src="/assets/images/icon-tick.png" height="11" alt="Check mark">
              Match funds are currently available!
            </p>
            <mat-form-field class="c-your-donation__form-field b-center size-lg" color="primary">
              <mat-label for="donationAmount">Donation to {{ campaign.charity.name }} (£)</mat-label>
              <input formControlName="donationAmount" id="donationAmount" matInput>
            </mat-form-field>
            <p *ngIf="suggestedAmounts && suggestedAmounts.length > 0" class="b-center b-grey b-rt-0">Or, choose</p>
            <div *ngIf="suggestedAmounts && suggestedAmounts.length > 0" class="c-suggested-amount" fxLayout="row">
              <button
                class="c-suggested-amount__button b-rh-2 b-bold"
                type="button"
                *ngFor="let suggestedAmount of suggestedAmounts"
                (click)="setAmount(suggestedAmount)"
              >{{ suggestedAmount | exactCurrency }}</button>
            </div>

            <div class="error" aria-live="polite" *ngIf="f.donationAmount.invalid && f.donationAmount.errors && (f.donationAmount.dirty || f.donationAmount.touched)">
              <div *ngIf="f.donationAmount.errors.min">Sorry, the minimum donation is currently £5.</div>
              <div *ngIf="f.donationAmount.errors.max">Your donation must be {{ maximumDonationAmount | exactCurrency }} or less to proceed. You can make multiple matched donations of {{ maximumDonationAmount | exactCurrency }} if match funds are available.</div>
              <div *ngIf="f.donationAmount.errors.pattern">Please enter a whole number of pounds (£) without commas.</div>
              <div *ngIf="f.donationAmount.errors.required">Please enter how much you would like to donate.</div>
            </div>

            <h2 class="b-rh-2">Support the Big Give</h2>
            <p class="b-rt-0">The Big Give is the UK's #1 match funding platform, but we're a <a href="https://beta.charitycommission.gov.uk/charity-details/?regid=1136547" target="_blank"><mat-icon class="b-va-mid" aria-hidden="false" aria-label="Open in new tab">open_in_new</mat-icon>charity</a> too!</p>
            <p class="b-rt-0">We develop and operate the technology, and support charities as they create and run their campaigns. Donations make a vital contribution to our running costs as a charity.</p>

            <mat-form-field class="c-your-donation__form-field b-center" color="primary">
              <mat-label for="donationAmount">Optional donation to the Big Give (£)</mat-label>
              <input formControlName="tipAmount" id="tipAmount" matInput>
            </mat-form-field>

            <div>
              <button matStepperNext mat-raised-button color="primary">Next</button>
            </div>
          </mat-step>

          <mat-step *ngIf="donationForm" label="Gift Aid and you">
            <ng-template matStepperIcon="edit">
              <mat-icon>add_circle_outline</mat-icon>
            </ng-template>

            <h2 class="b-rh-2" id="giftAid-label">Gift Aid</h2>
            <p class="no-margin-top b-rt-1 b-bold">Boost your donation by 25p of Gift Aid for every £1 you donate.</p>
            <p class="b-rt-0">'I confirm that I am a UK tax payer and I understand that if I pay less income tax and/or capital gains tax in the current tax year than the amount of Gift Aid claimed on all my donations it is my responsibility to pay the difference'.</p>
            <p class="b-rt-0">Gift Aid is a government scheme for UK charities to reclaim the tax you have paid and gain 25% more at no cost or hassle to you.
              <a href="https://www.thebiggive.org.uk/s/terms-and-conditions" target="_blank">
                <mat-icon class="b-va-mid" aria-hidden="false" aria-label="Open in new tab">open_in_new</mat-icon>
                  Find out more about Gift Aid</a>.
            </p>
            <mat-radio-group tabindex="0" aria-labelledby="giftAid-label" formControlName="giftAid">
              <mat-radio-button class="b-mr-2" labelPosition="after" [value]="true">Yes, I want to Gift Aid my donation to {{ campaign.charity.name }} and any additional gift I make to the Big Give, including any donations made in the past 4 years or in the future</mat-radio-button>
              <mat-radio-button class="b-mr-2" labelPosition="after" [value]="false">No, I do not meet the criteria for Gift Aid to be claimed, or do not want Gift Aid claimed</mat-radio-button>
            </mat-radio-group>

            <mat-label for="name">Your name</mat-label>
            <p class="b-rt-0">Your legal name, for your Gift Aid declaration and to let us confirm who we're speaking with if you have any questions.</p>
            <input formControlName="name" id="name" matInput>

            <div *ngIf="donationForm && donationForm.value.giftAid">
              <!-- TODO split out pieces, probably use a lookup service -->
              <mat-label for="homeAddress">Home address</mat-label>
              <input formControlName="homeAddress" id="homeAddress" matInput>

              <mat-label for="homePostcode">Home postcode</mat-label>
              <p class="b-rt-0">This is where you live, for your Gift Aid declaration to HMRC.</p>
              <input formControlName="homePostcode" id="homePostcode" matInput>
            </div>

            <mat-label for="billingPostcode">Billing postcode</mat-label>
            <p class="b-rt-0">This should match where your payment card is registered.</p>
            <input formControlName="billingPostcode" id="billingPostcode" matInput>

            <div>
              <button matStepperNext mat-raised-button color="primary">Next</button>
            </div>
          </mat-step>

          <!-- TODO step control should be based on both opt ins -->
          <mat-step *ngIf="donationForm" label="Receipt and updates">
            <ng-template matStepperIcon="edit">
              <mat-icon>email</mat-icon>
            </ng-template>

            <h3 class="b-rt-3">Your email</h3>
            <p class="b-rt-0">We'll send you a donation receipt and use this to
              confirm it's you in case you have any queries. All later
              communication is optional.</p>
            <mat-label for="emailAddress">Email address</mat-label>
            <input formControlName="emailAddress" id="emailAddress" type="email" matInput>

            <h3 class="b-rt-3" id="optInCharityEmail-label">Contact from charity</h3>
            <p class="no-margin-top b-rt-1 b-bold">Would you be happy to receive emails from {{ campaign.charity.name }}?</p>
            <p class="b-rt-0">This may include thanks for your donation, updates on how it is being used, newsletters and future campaigns. If you select no, we will pass on your details as these may be required for Gift Aid purposes, but the charity will be informed that you do not wish to receive communications.</p>
            <p class="b-rt-0">Please note that you might continue to receive communications from {{ campaign.charity.name }} if you have already shared your details with them via other methods.</p>
            <mat-radio-group tabindex="0" aria-labelledby="optInCharityEmail-label" formControlName="optInCharityEmail">
              <mat-radio-button class="b-mr-2" labelPosition="after" [value]="true">Yes, I'm happy to receive emails from {{ campaign.charity.name }}</mat-radio-button>
              <mat-radio-button class="b-mr-2" labelPosition="after" [value]="false">No, I would not like to receive emails from {{ campaign.charity.name }}</mat-radio-button>
            </mat-radio-group>

            <h3 class="b-rh-2" id="optInTbgEmail-label">Contact from the Big Give</h3>
            <p class="no-margin-top b-rt-1 b-bold">Would you be happy to receive emails from the Big Give?</p>
            <mat-radio-group tabindex="0" aria-labelledby="optInTbgEmail-label" formControlName="optInTbgEmail">
              <mat-radio-button class="b-mr-2" labelPosition="after" [value]="true">Yes, I'm happy to receive emails from the Big Give</mat-radio-button>
              <mat-radio-button class="b-mr-2" labelPosition="after" [value]="false">No, I would not like to receive emails from the Big Give</mat-radio-button>
            </mat-radio-group>

            <p *ngIf="donationForm.value.optInTbgEmail === false" class="error" aria-live="polite">
              By selecting 'no', we will no longer be able to email you about opportunities to double your donation.
            </p>

            <div>
              <button matStepperNext mat-raised-button color="primary">Next</button>
            </div>
          </mat-step>

          <mat-step *ngIf="donationForm" state="done_outline" label="Confirm" class="c-make-your-donation">
            <ng-template matStepperIcon="done_outline">
              <mat-icon>done_outline</mat-icon>
            </ng-template>

            <p class="b-rt-0 b-m-0">By clicking on the <em>Donate</em> button, you agree to the Big Give's
              <a href="https://www.thebiggive.org.uk/s/terms-and-conditions" target="_blank">
                <mat-icon class="b-va-mid" aria-hidden="false" aria-label="Open in new tab">open_in_new</mat-icon>
                  Terms and Conditions
              </a>
                and
              <a href="https://www.thebiggive.org.uk/s/privacy-policy" target="_blank">
                <mat-icon class="b-va-mid" aria-hidden="false" aria-label="Open in new tab">open_in_new</mat-icon>
                  Privacy Policy
                </a>
                .
            </p>

            <div class="c-donation-summary">
              <p class="error" *ngIf="sfApiError" aria-live="alert">
                Sorry, we can't submit your donation right now. Please try again in a moment
                or <a href="https://www.thebiggive.org.uk/s/contact-us" target="_blank">
                  <mat-icon aria-hidden="false" aria-label="Open in new tab">open_in_new</mat-icon>
                    contact us</a>
                if this message persists.
              </p>
              <p class="error" *ngIf="donationForm.invalid" aria-live="polite">
                Please complete all fields above to proceed with your donation.
              </p>
              <p class="error" *ngIf="f.donationAmount.invalid" aria-live="polite">
                Please check your donation amount above. It must be a whole number of pounds without commas.
              </p>
              <mat-spinner *ngIf="submitting" color="primary" diameter="30"></mat-spinner>
              <p *ngIf="retrying" class="error" aria-live="polite">
                It looks like our system is a bit busy, one moment please&hellip;
              </p>
              <button
                class="c-donate-button b-donate-button b-w-100 b-rt-1"
                mat-raised-button
                type="submit"
                [disabled]="submitting || f.donationAmount.invalid"
              >
                Donate
                <span class="b-bold b-va-bas">
                  {{ donationForm.value.donationAmount | exactCurrency }}
                </span>
              </button>
              <div *ngIf="!f.donationAmount.invalid" class="c-donation-receipt" fxLayout="row">
                <div [fxFlex]="(expectedMatchAmount() > 0) ? 26 : 39">
                  <p class="b-center b-grey b-rt-sm b-m-0">Your donation</p>
                  <p class="b-center b-grey b-rt-0 b-bold b-m-0">{{ donationForm.value.donationAmount | exactCurrency }}</p>
                </div>
                <div fxFlex="11" fxLayout="row" fxLayoutAlign="center end">
                  <mat-icon class="c-donation-receipt__icon b-grey b-bold b-center" aria-hidden="false" aria-label="Plus">add</mat-icon>
                </div>
                <div fxFlex="26" *ngIf="expectedMatchAmount() > 0">
                  <p class="b-center b-grey b-rt-sm b-m-0">Match funds</p>
                  <p class="b-center b-grey b-rt-0 b-bold b-m-0">{{ expectedMatchAmount() | exactCurrency }}</p>
                </div>
                <div fxFlex="11" fxLayout="row" fxLayoutAlign="center end" *ngIf="expectedMatchAmount() > 0">
                  <mat-icon class="c-donation-receipt__icon b-grey b-bold b-center" aria-hidden="false" aria-label="Plus">add</mat-icon>
                </div>
                <div class="c-donation-receipt__gift-aid" [fxFlex]="(expectedMatchAmount() > 0) ? 26 : 39">
                  <p class="b-center b-grey b-rt-sm b-m-0">Gift Aid</p>
                  <p class="b-center b-grey b-rt-0 b-bold b-m-0">{{ giftAidAmount() | exactCurrency }}</p>
                </div>
              </div>
              <div *ngIf="!f.donationAmount.invalid" class="c-receipt-total b-grey" fxLayout="row" fxLayoutAlign="space-around center">
                <p class="b-rt-0 b-m-0">Total for {{ campaign.charity.name }}:</p>
                <p class="b-rt-1 b-bold b-m-0">{{ expectedTotalAmount() | exactCurrency }}</p>
              </div>
            </div>

            <p *ngIf="noPsps" class="error" aria-live="alert">
              Sorry, we are really busy and cannot take your donation right now. Please refresh the page in a few minutes to try again.
            </p>
          </mat-step>

          <mat-step *ngIf="cardDetailsEventually" label="Payment details">
            <div class="sr-combo-inputs-row">
              <mat-label for="card-info">Card</mat-label>
              <div class="sr-input sr-card-element" id="card-element" #cardInfo></div>
            </div>

            <div role="alert" aria-live="alert" class="error" *ngIf="stripeProcessingError">{{ stripeProcessingError }}</div>

            <!-- For now we rely on Stripe's inline styling to highlight mistakes
            instead of showing stripeValidationError text, and just disable the Pay
            button outside of Elements, until the card is valid. -->
            <button
              class="c-donate-button b-donate-button b-w-100 b-rt-1"
              mat-raised-button
              [disabled]="stripeValidationError || submitting || f.donationAmount.invalid"
              (click)="payWithStripe()"
            >
              Pay
              <span class="b-bold b-va-bas">
                {{ donationForm.value.donationAmount | exactCurrency }}
              </span>
            </button>
          </mat-step>
        </mat-vertical-stepper>
      </form>
    </div>

    <div class="b-secondary-column">
      <app-campaign-details-card [campaign]="campaign"></app-campaign-details-card>
    </div>
  </div>
</main>
